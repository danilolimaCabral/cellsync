import { useState, useEffect } from "react";
import { trpc } from "@/lib/trpc";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Loader2, Plus, Trash2, Download, Package } from "lucide-react";
import { toast } from "sonner";

interface ShippingQuote {
  id: string;
  carrier: string;
  service: string;
  price: number;
  deliveryTime: number;
  source: "correios" | "melhor_envio";
  logo?: string;
}

interface LabelForm {
  // Destinatário
  recipientName: string;
  recipientCpf: string;
  recipientAddress: string;
  recipientNumber: string;
  recipientComplement: string;
  recipientNeighborhood: string;
  recipientCity: string;
  recipientState: string;
  recipientZipCode: string;
  recipientPhone: string;
  
  // Remetente
  senderName: string;
  senderAddress: string;
  senderNumber: string;
  senderComplement: string;
  senderNeighborhood: string;
  senderCity: string;
  senderState: string;
  senderZipCode: string;
  senderPhone: string;
  
  // Pacote
  weight: string; // gramas
  length: string; // cm
  width: string; // cm
  height: string; // cm
  
  // Transportadora
  carrier: string;
  trackingCode: string;
  
  // Cotações
  quotes: ShippingQuote[];
  selectedQuote: ShippingQuote | null;
  shippingCost: number; // em centavos
  
  // Tipo
  labelType: "simple" | "correios";
}

const emptyLabel: LabelForm = {
  recipientName: "",
  recipientCpf: "",
  recipientAddress: "",
  recipientNumber: "",
  recipientComplement: "",
  recipientNeighborhood: "",
  recipientCity: "",
  recipientState: "",
  recipientZipCode: "",
  recipientPhone: "",
  senderName: "",
  senderAddress: "",
  senderNumber: "",
  senderComplement: "",
  senderNeighborhood: "",
  senderCity: "",
  senderState: "",
  senderZipCode: "",
  senderPhone: "",
  weight: "500",
  length: "20",
  width: "15",
  height: "10",
  carrier: "",
  trackingCode: "",
  quotes: [],
  selectedQuote: null,
  shippingCost: 0,
  labelType: "correios",
};

export default function EtiquetasEnvio() {
  const [labels, setLabels] = useState<LabelForm[]>([{ ...emptyLabel }]);
  const [loadingZipCode, setLoadingZipCode] = useState<{ [key: number]: boolean }>({});
  
  const generateMutation = trpc.shippingLabels.generate.useMutation();
  const tenantQuery = trpc.tenants.getCurrent.useQuery();

  // Preencher dados do remetente com dados da loja
  useEffect(() => {
    if (tenantQuery.data) {
      const tenant = tenantQuery.data;
      setLabels((prev) =>
        prev.map((label) => ({
          ...label,
          senderName: tenant.name || "",
          senderAddress: tenant.logradouro || "",
          senderNumber: tenant.numero || "",
          senderComplement: tenant.complemento || "",
          senderNeighborhood: tenant.bairro || "",
          senderCity: tenant.cidade || "",
          senderState: tenant.estado || "",
          senderZipCode: tenant.cep || "",
          senderPhone: tenant.telefone || "",
        }))
      );
    }
  }, [tenantQuery.data]);

  const handleAddLabel = () => {
    const lastLabel = labels[labels.length - 1];
    setLabels([
      ...labels,
      {
        ...emptyLabel,
        // Manter dados do remetente
        senderName: lastLabel.senderName,
        senderAddress: lastLabel.senderAddress,
        senderNumber: lastLabel.senderNumber,
        senderComplement: lastLabel.senderComplement,
        senderNeighborhood: lastLabel.senderNeighborhood,
        senderCity: lastLabel.senderCity,
        senderState: lastLabel.senderState,
        senderZipCode: lastLabel.senderZipCode,
        senderPhone: lastLabel.senderPhone,
        carrier: lastLabel.carrier,
        labelType: lastLabel.labelType,
      },
    ]);
  };

  const handleRemoveLabel = (index: number) => {
    if (labels.length === 1) {
      toast.error("Você precisa ter pelo menos uma etiqueta");
      return;
    }
    setLabels(labels.filter((_, i) => i !== index));
  };

  const handleLabelChange = (index: number, field: keyof LabelForm, value: string) => {
    const newLabels = [...labels];
    newLabels[index] = { ...newLabels[index], [field]: value };
    setLabels(newLabels);
  };

  const fetchAddressByZipCode = async (index: number, zipCode: string, type: "recipient" | "sender") => {
    const cleanZip = zipCode.replace(/\D/g, "");
    if (cleanZip.length !== 8) return;

    setLoadingZipCode({ ...loadingZipCode, [index]: true });

    try {
      const response = await fetch(`https://viacep.com.br/ws/${cleanZip}/json/`);
      const data = await response.json();

      if (data.erro) {
        toast.error("CEP não encontrado");
        return;
      }

      const newLabels = [...labels];
      if (type === "recipient") {
        newLabels[index] = {
          ...newLabels[index],
          recipientAddress: data.logradouro || "",
          recipientNeighborhood: data.bairro || "",
          recipientCity: data.localidade || "",
          recipientState: data.uf || "",
        };
      } else {
        newLabels[index] = {
          ...newLabels[index],
          senderAddress: data.logradouro || "",
          senderNeighborhood: data.bairro || "",
          senderCity: data.localidade || "",
          senderState: data.uf || "",
        };
      }
      setLabels(newLabels);
      toast.success("Endereço preenchido automaticamente");
    } catch (error) {
      toast.error("Erro ao buscar CEP");
    } finally {
      setLoadingZipCode({ ...loadingZipCode, [index]: false });
    }
  };

  const handleGenerate = async () => {
    // Validar campos obrigatórios
    for (let i = 0; i < labels.length; i++) {
      const label = labels[i];
      if (
        !label.recipientName ||
        !label.recipientAddress ||
        !label.recipientNumber ||
        !label.recipientNeighborhood ||
        !label.recipientCity ||
        !label.recipientState ||
        !label.recipientZipCode ||
        !label.recipientPhone ||
        !label.senderName ||
        !label.senderAddress ||
        !label.senderNumber ||
        !label.senderNeighborhood ||
        !label.senderCity ||
        !label.senderState ||
        !label.senderZipCode
      ) {
        toast.error(`Preencha todos os campos obrigatórios da etiqueta ${i + 1}`);
        return;
      }
    }

    try {
      const result = await generateMutation.mutateAsync({ labels });

      // Baixar PDF
      const linkSource = `data:application/pdf;base64,${result.pdf}`;
      const downloadLink = document.createElement("a");
      const fileName = `etiquetas_envio_${new Date().getTime()}.pdf`;

      downloadLink.href = linkSource;
      downloadLink.download = fileName;
      downloadLink.click();

      toast.success(`${labels.length} etiqueta(s) gerada(s) com sucesso!`);
    } catch (error) {
      toast.error("Erro ao gerar etiquetas");
      console.error(error);
    }
  };

  return (
    <div className="container mx-auto p-6 max-w-7xl">
      <div className="flex items-center justify-between mb-6">
        <div>
          <h1 className="text-3xl font-bold flex items-center gap-2">
            <Package className="h-8 w-8" />
            Etiquetas de Envio
          </h1>
          <p className="text-muted-foreground mt-1">
            Gere etiquetas de envio com código de barras para Correios e transportadoras
          </p>
        </div>
        <div className="flex gap-2">
          <Button onClick={handleAddLabel} variant="outline">
            <Plus className="h-4 w-4 mr-2" />
            Adicionar Etiqueta
          </Button>
          <Button
            onClick={handleGenerate}
            disabled={generateMutation.isPending}
          >
            {generateMutation.isPending ? (
              <>
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                Gerando...
              </>
            ) : (
              <>
                <Download className="h-4 w-4 mr-2" />
                Gerar PDF ({labels.length})
              </>
            )}
          </Button>
        </div>
      </div>

      <div className="space-y-6">
        {labels.map((label, index) => (
          <Card key={index}>
            <CardHeader>
              <div className="flex items-center justify-between">
                <div>
                  <CardTitle>Etiqueta #{index + 1}</CardTitle>
                  <CardDescription>
                    Preencha os dados do destinatário e remetente
                  </CardDescription>
                </div>
                <div className="flex items-center gap-2">
                  <Select
                    value={label.labelType}
                    onValueChange={(value) =>
                      handleLabelChange(index, "labelType", value)
                    }
                  >
                    <SelectTrigger className="w-[180px]">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="simple">Etiqueta Simples</SelectItem>
                      <SelectItem value="correios">Correios</SelectItem>
                    </SelectContent>
                  </Select>
                  {labels.length > 1 && (
                    <Button
                      variant="destructive"
                      size="icon"
                      onClick={() => handleRemoveLabel(index)}
                    >
                      <Trash2 className="h-4 w-4" />
                    </Button>
                  )}
                </div>
              </div>
            </CardHeader>
            <CardContent>
              <Tabs defaultValue="recipient">
                <TabsList className="grid w-full grid-cols-3">
                  <TabsTrigger value="recipient">Destinatário</TabsTrigger>
                  <TabsTrigger value="sender">Remetente</TabsTrigger>
                  <TabsTrigger value="shipping">Envio</TabsTrigger>
                </TabsList>

                {/* Destinatário */}
                <TabsContent value="recipient" className="space-y-4">
                  <div className="grid grid-cols-2 gap-4">
                    <div className="col-span-2">
                      <Label htmlFor={`recipient-name-${index}`}>Nome Completo *</Label>
                      <Input
                        id={`recipient-name-${index}`}
                        value={label.recipientName}
                        onChange={(e) =>
                          handleLabelChange(index, "recipientName", e.target.value)
                        }
                        placeholder="Nome completo do destinatário"
                      />
                    </div>

                    <div>
                      <Label htmlFor={`recipient-cpf-${index}`}>CPF</Label>
                      <Input
                        id={`recipient-cpf-${index}`}
                        value={label.recipientCpf}
                        onChange={(e) =>
                          handleLabelChange(index, "recipientCpf", e.target.value)
                        }
                        placeholder="000.000.000-00"
                      />
                    </div>

                    <div>
                      <Label htmlFor={`recipient-phone-${index}`}>Telefone *</Label>
                      <Input
                        id={`recipient-phone-${index}`}
                        value={label.recipientPhone}
                        onChange={(e) =>
                          handleLabelChange(index, "recipientPhone", e.target.value)
                        }
                        placeholder="(00) 00000-0000"
                      />
                    </div>

                    <div>
                      <Label htmlFor={`recipient-zipcode-${index}`}>CEP *</Label>
                      <div className="flex gap-2">
                        <Input
                          id={`recipient-zipcode-${index}`}
                          value={label.recipientZipCode}
                          onChange={(e) =>
                            handleLabelChange(index, "recipientZipCode", e.target.value)
                          }
                          onBlur={(e) =>
                            fetchAddressByZipCode(index, e.target.value, "recipient")
                          }
                          placeholder="00000-000"
                        />
                        {loadingZipCode[index] && (
                          <Loader2 className="h-4 w-4 animate-spin" />
                        )}
                      </div>
                    </div>

                    <div>
                      <Label htmlFor={`recipient-address-${index}`}>Logradouro *</Label>
                      <Input
                        id={`recipient-address-${index}`}
                        value={label.recipientAddress}
                        onChange={(e) =>
                          handleLabelChange(index, "recipientAddress", e.target.value)
                        }
                        placeholder="Rua, Avenida, etc"
                      />
                    </div>

                    <div className="grid grid-cols-2 gap-2">
                      <div>
                        <Label htmlFor={`recipient-number-${index}`}>Número *</Label>
                        <Input
                          id={`recipient-number-${index}`}
                          value={label.recipientNumber}
                          onChange={(e) =>
                            handleLabelChange(index, "recipientNumber", e.target.value)
                          }
                          placeholder="123"
                        />
                      </div>
                      <div>
                        <Label htmlFor={`recipient-complement-${index}`}>Complemento</Label>
                        <Input
                          id={`recipient-complement-${index}`}
                          value={label.recipientComplement}
                          onChange={(e) =>
                            handleLabelChange(index, "recipientComplement", e.target.value)
                          }
                          placeholder="Apto, Bloco, etc"
                        />
                      </div>
                    </div>

                    <div>
                      <Label htmlFor={`recipient-neighborhood-${index}`}>Bairro *</Label>
                      <Input
                        id={`recipient-neighborhood-${index}`}
                        value={label.recipientNeighborhood}
                        onChange={(e) =>
                          handleLabelChange(index, "recipientNeighborhood", e.target.value)
                        }
                        placeholder="Bairro"
                      />
                    </div>

                    <div className="grid grid-cols-3 gap-2">
                      <div className="col-span-2">
                        <Label htmlFor={`recipient-city-${index}`}>Cidade *</Label>
                        <Input
                          id={`recipient-city-${index}`}
                          value={label.recipientCity}
                          onChange={(e) =>
                            handleLabelChange(index, "recipientCity", e.target.value)
                          }
                          placeholder="Cidade"
                        />
                      </div>
                      <div>
                        <Label htmlFor={`recipient-state-${index}`}>UF *</Label>
                        <Input
                          id={`recipient-state-${index}`}
                          value={label.recipientState}
                          onChange={(e) =>
                            handleLabelChange(index, "recipientState", e.target.value)
                          }
                          placeholder="SP"
                          maxLength={2}
                        />
                      </div>
                    </div>
                  </div>
                </TabsContent>

                {/* Remetente */}
                <TabsContent value="sender" className="space-y-4">
                  <div className="grid grid-cols-2 gap-4">
                    <div className="col-span-2">
                      <Label htmlFor={`sender-name-${index}`}>Nome/Razão Social *</Label>
                      <Input
                        id={`sender-name-${index}`}
                        value={label.senderName}
                        onChange={(e) =>
                          handleLabelChange(index, "senderName", e.target.value)
                        }
                        placeholder="Nome do remetente"
                      />
                    </div>

                    <div>
                      <Label htmlFor={`sender-phone-${index}`}>Telefone</Label>
                      <Input
                        id={`sender-phone-${index}`}
                        value={label.senderPhone}
                        onChange={(e) =>
                          handleLabelChange(index, "senderPhone", e.target.value)
                        }
                        placeholder="(00) 00000-0000"
                      />
                    </div>

                    <div>
                      <Label htmlFor={`sender-zipcode-${index}`}>CEP *</Label>
                      <div className="flex gap-2">
                        <Input
                          id={`sender-zipcode-${index}`}
                          value={label.senderZipCode}
                          onChange={(e) =>
                            handleLabelChange(index, "senderZipCode", e.target.value)
                          }
                          onBlur={(e) =>
                            fetchAddressByZipCode(index, e.target.value, "sender")
                          }
                          placeholder="00000-000"
                        />
                        {loadingZipCode[index] && (
                          <Loader2 className="h-4 w-4 animate-spin" />
                        )}
                      </div>
                    </div>

                    <div>
                      <Label htmlFor={`sender-address-${index}`}>Logradouro *</Label>
                      <Input
                        id={`sender-address-${index}`}
                        value={label.senderAddress}
                        onChange={(e) =>
                          handleLabelChange(index, "senderAddress", e.target.value)
                        }
                        placeholder="Rua, Avenida, etc"
                      />
                    </div>

                    <div className="grid grid-cols-2 gap-2">
                      <div>
                        <Label htmlFor={`sender-number-${index}`}>Número *</Label>
                        <Input
                          id={`sender-number-${index}`}
                          value={label.senderNumber}
                          onChange={(e) =>
                            handleLabelChange(index, "senderNumber", e.target.value)
                          }
                          placeholder="123"
                        />
                      </div>
                      <div>
                        <Label htmlFor={`sender-complement-${index}`}>Complemento</Label>
                        <Input
                          id={`sender-complement-${index}`}
                          value={label.senderComplement}
                          onChange={(e) =>
                            handleLabelChange(index, "senderComplement", e.target.value)
                          }
                          placeholder="Apto, Bloco, etc"
                        />
                      </div>
                    </div>

                    <div>
                      <Label htmlFor={`sender-neighborhood-${index}`}>Bairro *</Label>
                      <Input
                        id={`sender-neighborhood-${index}`}
                        value={label.senderNeighborhood}
                        onChange={(e) =>
                          handleLabelChange(index, "senderNeighborhood", e.target.value)
                        }
                        placeholder="Bairro"
                      />
                    </div>

                    <div className="grid grid-cols-3 gap-2">
                      <div className="col-span-2">
                        <Label htmlFor={`sender-city-${index}`}>Cidade *</Label>
                        <Input
                          id={`sender-city-${index}`}
                          value={label.senderCity}
                          onChange={(e) =>
                            handleLabelChange(index, "senderCity", e.target.value)
                          }
                          placeholder="Cidade"
                        />
                      </div>
                      <div>
                        <Label htmlFor={`sender-state-${index}`}>UF *</Label>
                        <Input
                          id={`sender-state-${index}`}
                          value={label.senderState}
                          onChange={(e) =>
                            handleLabelChange(index, "senderState", e.target.value)
                          }
                          placeholder="SP"
                          maxLength={2}
                        />
                      </div>
                    </div>
                  </div>
                </TabsContent>

                {/* Envio */}
                <TabsContent value="shipping" className="space-y-4">
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <Label htmlFor={`carrier-${index}`}>Transportadora</Label>
                      <Input
                        id={`carrier-${index}`}
                        value={label.carrier}
                        onChange={(e) =>
                          handleLabelChange(index, "carrier", e.target.value)
                        }
                        placeholder="Ex: Correios, Jadlog, Total Express"
                      />
                    </div>

                    <div>
                      <Label htmlFor={`tracking-${index}`}>Código de Rastreamento</Label>
                      <Input
                        id={`tracking-${index}`}
                        value={label.trackingCode}
                        onChange={(e) =>
                          handleLabelChange(index, "trackingCode", e.target.value)
                        }
                        placeholder="Ex: BR123456789BR"
                      />
                    </div>
                  </div>
                </TabsContent>
              </Tabs>
            </CardContent>
          </Card>
        ))}
      </div>
    </div>
  );
}
